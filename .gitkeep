import json
from datetime import date
from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes

TOKEN = "SEU_TOKEN_DO_BOT"

ARQUIVO = "dados_diarios.json"

def carregar():
    try:
        with open(ARQUIVO, "r") as f:
            return json.load(f)
    except:
        return {}

def salvar(dados):
    with open(ARQUIVO, "w") as f:
        json.dump(dados, f, indent=2)

# ğŸ“‹ MENU
async def menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ğŸ“Š *Controle DiÃ¡rio*\n\n"
        "/setdiaria 10 â†’ definir meta diÃ¡ria\n"
        "/registrar â†’ somar +1 hoje\n"
        "/status â†’ ver andamento do dia\n"
        "/verdiaria â†’ ver meta atual",
        parse_mode="Markdown"
    )

# ğŸ¯ DEFINIR META
async def setdiaria(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not context.args:
        await update.message.reply_text("Use: /setdiaria 10")
        return

    try:
        meta = int(context.args[0])
    except:
        await update.message.reply_text("A meta precisa ser um nÃºmero.")
        return

    dados = carregar()
    dados["meta"] = meta
    salvar(dados)

    await update.message.reply_text(f"âœ… Meta diÃ¡ria definida: {meta}")

# â• REGISTRAR
async def registrar(update: Update, context: ContextTypes.DEFAULT_TYPE):
    hoje = str(date.today())
    dados = carregar()

    dados.setdefault("producao", {})
    dados["producao"][hoje] = dados["producao"].get(hoje, 0) + 1

    salvar(dados)
    await update.message.reply_text("â• Registro feito para hoje")

# ğŸ“ˆ STATUS
async def status(update: Update, context: ContextTypes.DEFAULT_TYPE):
    hoje = str(date.today())
    dados = carregar()

    feito = dados.get("producao", {}).get(hoje, 0)
    meta = dados.get("meta", "nÃ£o definida")

    await update.message.reply_text(
        f"ğŸ“… Data: {hoje}\n"
        f"âœ”ï¸ Feito hoje: {feito}\n"
        f"ğŸ¯ Meta diÃ¡ria: {meta}"
    )

# ğŸ‘€ VER META
async def verdiaria(update: Update, context: ContextTypes.DEFAULT_TYPE):
    dados = carregar()
    meta = dados.get("meta", "nÃ£o definida")

    await update.message.reply_text(f"ğŸ¯ Meta diÃ¡ria atual: {meta}")

# â–¶ï¸ BOT
app = ApplicationBuilder().token(TOKEN).build()

app.add_handler(CommandHandler("menu", menu))
app.add_handler(CommandHandler("setdiaria", setdiaria))
app.add_handler(CommandHandler("registrar", registrar))
app.add_handler(CommandHandler("status", status))
app.add_handler(CommandHandler("verdiaria", verdiaria))

print("ğŸ¤– Bot diÃ¡rio rodando...")
app.run_polling()
